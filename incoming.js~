console.log('STARTING phantomtest.js');
var url = 'https://incoming.shopify.com/';
var page = require('webpage').create();
page.settings.userAgent = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.98 Safari/537.36';
page.viewportSize = { width: 1024, height: 768 };

page.onConsoleMessage = function(msg, lineNum, sourceId) {
    console.log('CONSOLE: ' + msg + ' (from line #' + lineNum + ' in "' + sourceId + '")');
};

var startToken = '__OUTPUT_SENTINEL_START__';
var endToken = '__OUTPUT_SENTINEL_END__';

page.open(url, function(status) {
    if(status === "success") {
        console.log('Loaded page successfully.');
        setTimeout(function() {
            
            console.log('Loading jQuery...');
            page.includeJs("//ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js", function() {                
                var links = page.evaluate(function() {
                    var urls = [];
                    $('#products a').each(function(index,a) {
                        urls.push($(a).attr('href'));
                    });
                    return urls;
                });
                console.log(startToken+JSON.stringify(links)+endToken);
            });
            
            setTimeout(function() {
                page.render('example.png');
                phantom.exit();
            },5000);
        },2000);
    } else {
        phantom.exit();
    }
});
